{% extends 'main/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Editar Reporte Digital{% endblock %}

{% block css %}
    <link href="{% static 'css/jquery.dataTables.min.css' %}" rel="stylesheet" />
    <link href="{% static 'css/responsive.dataTables.min.css' %}" rel="stylesheet" />
    <link href="{% static 'css/floating.css' %}" rel="stylesheet" />
    <link href="{% static 'css/flatpickr.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/tempus-dominus.min.css' %}" rel="stylesheet"  crossorigin="anonymous">
{% endblock css %}
{% block select2 %}
    <link href="{% static 'css/select2.min.css' %}" rel="stylesheet" />
{% endblock select2 %}

{% block content %}

{% if reporte.progreso != 'Aprobado' and reporte.progreso != 'Eliminado' %}
<button id="saveButton" class="btn btn-primary save-float">Guardar</button>
{% endif %}
{% if reporte.progreso == 'Creado' or reporte.progreso == 'Por Corregir' %}
<a href="{% url 'manage_mis_reportes_digitales' %}" class="btn btn-secondary back-float">Regresar</a>
{% endif %}
{% if reporte.progreso == 'Por Revisar' or reporte.progreso == 'Corregido' %}
<a href="{% url 'manage_revisar_reportes_digitales' %}" class="btn btn-secondary back-float">Regresar</a>
{% endif %}
{% if reporte.progreso == 'Aprobado' %}
<a href="{% url 'manage_todos_reportes_digitales' %}" class="btn btn-secondary back-float">Regresar</a>
{% endif %}
{% if reporte.progreso == 'Eliminado' %}
<a href="{% url 'manage_mis_reportes_digitales_eliminados' %}" class="btn btn-secondary back-float">Regresar</a>
{% endif %}

<div class="app-content main-content mt-0">
    <div class="side-app"> <!-- CONTAINER -->
        <div class="main-container container-fluid"> <!-- PAGE-HEADER -->
            <div class="page-header">
                <div>
                    <h1 class="page-title">Editar Reporte Digital</h1>
                </div>
                <div class="ms-auto pageheader-btn">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="javascript:void(0);">Reportes Digitales</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Editar Reporte</li>
                    </ol>
                </div>
            </div> <!-- PAGE-HEADER END --> <!-- row -->

            <div class="card"> 
                <div class="panel panel-primary">
                    <div class="tab-menu-heading border-bottom-0"> 
                        <div class="tabs-menu4 border-bottomo-sm"> 
                            <!-- Tabs --> 
                            <nav class="nav d-sm-flex d-block"> 
                                <a id="nav25" class="nav-link border border-bottom-0 br-sm-5 me-2 active" data-bs-toggle="tab" href="#tab25">Checklist Entrada</a> 
                                <a id="nav26" class="nav-link border border-bottom-0 br-sm-5 me-2 " data-bs-toggle="tab" href="#tab26">Reporte Digital</a>
                                <a id="nav27" class="nav-link border border-bottom-0 br-sm-5 me-2 " data-bs-toggle="tab" href="#tab27">Checklist Salida</a>
                                
                            </nav> 
                        </div> 
                    </div>
                    <div class="panel-body tabs-menu-body"> 
                        <div class="tab-content">
                            <div class="tab-pane active" id="tab25">
                                <div class="row row-sm">
                                    <div class="col-lg-12 col-xl-12 col-md-12 col-sm-12">
                                        <div class="card box-shadow-0">                        
                                            <div class="card-body">
                                                <h4 class="card-title">Checklist Entrada</h4>
                                                <p class="card-title">Atención: una vez creado no podrás eliminar este registro</p>
                                                <form class="form-horizontal" id="formChecklistEntrada" action="#" method="POST">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="origin" value="{{origen}}">
                                                    <input type="hidden" name="id" value="{{id_checklist}}">
                                                    <div class="card box-shadow-0">
                                                        <div class="card-body">
                                                            <div class="row row-sm">
                                                                {{ formInicio|crispy }}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card box-shadow-0">
                                                        <div class="card-body">
                                                            <div class="row row-sm">
                                                                <div class="form-group" style="display: flex;">
                                                                    <h5 class="col-md-3">Item</h5>
                                                                    <h5 class="col-md-2">Cantidad</h5>
                                                                </div>
                                                                {% for check in checklistEntrada %}
                                                                    <div class="form-group" style="display: flex;">
                                                                        <label class="col-md-3">{{check.item}}</label>
                                                                        <input type="number" name="cantidad_{{ check.id }}" min="0" value="{{check.cantidad}}" class="form-control col-md-2" {% if reporte.progreso == 'Aprobado' or reporte.progreso == 'Eliminado' %}disabled{% endif %}>
                                                                    </div>
                                                                {% endfor %}
                                                                {% if not es_solo_lectura %}
                                                                <p style="margin-top: 10px; font-style: italic;">Cantidades vacías serán autocompletadas con ceros</p>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>  
                                        </div>
                                    </div>                
                                </div>
                            </div>
                            <div class="tab-pane" id="tab26">    
                                <div class="row row-sm">
                                    <div class="col-lg-12 col-xl-12 col-md-12 col-sm-12">
                                        <form class="form-horizontal" id="formReporte" action="#" method="POST">
                                            {% csrf_token %}
                                            <input type="hidden" name="origin" value="{{origen}}">
                                            <input type="hidden" name="id" value="{{id_checklist}}">
                                            <div class="card box-shadow-0">                        
                                                <div class="card-body">
                                                    <h4 class="card-title">Datos Principales</h4>
                                                    <p class="card-title">Atención: No podrás eliminar este registro</p>
                                                    <div class="row row-sm">
                                                        <div class="form-group" id="div_id_fechacreacion">
                                                            {{ formreporteoperacional.fechacreacion.label_tag }}
                                                            {{ formreporteoperacional.fechacreacion }}
                                                        </div>
                                                        <div class="form-group" id="div_id_perforista">
                                                            {{ formreporteoperacional.perforista.label_tag }}
                                                            {{ formreporteoperacional.perforista }}
                                                        </div>
                                                        <div class="form-group" id="div_id_metroInicial">
                                                            {{ formreporteoperacional.metroInicial.label_tag }}
                                                            {{ formreporteoperacional.metroInicial }}
                                                        </div>
                                                        <div class="form-group" id="div_id_turno">
                                                            {{ formreporteoperacional.turno.label_tag }}
                                                            {{ formreporteoperacional.turno }}
                                                        </div>
                                                        <div class="form-group" id="div_id_sonda">
                                                            {{ formreporteoperacional.sonda.label_tag }}
                                                            {{ formreporteoperacional.sonda }}
                                                        </div>
                                                        <div class="form-group" id="div_id_metroFinal">
                                                            {{ formreporteoperacional.metroFinal.label_tag }}
                                                            {{ formreporteoperacional.metroFinal }}
                                                        </div>
                                                        <div class="form-group" id="div_id_controlador">
                                                            {{ formreporteoperacional.controlador.label_tag }}
                                                            {{ formreporteoperacional.controlador }}
                                                        </div>
                                                        <div class="form-group" id="div_id_sondaje" style="display: flex;">
                                                            <div class="col-md-5" style="padding-left: 3px;padding-right: 3px;">
                                                                {{ formreporteoperacional.sondajeCodigo.label_tag }}
                                                                {{ formreporteoperacional.sondajeCodigo }}
                                                            </div>
                                                            <div class="col-md-5" style="padding-left: 3px;padding-right: 3px;">
                                                                {{ formreporteoperacional.sondajeSerie.label_tag }}
                                                                {{ formreporteoperacional.sondajeSerie }}
                                                            </div>
                                                            <div class="col-md-2" style="padding-left: 3px;padding-right: 3px;">
                                                                {{ formreporteoperacional.sondajeEstado.label_tag }}
                                                                {{ formreporteoperacional.sondajeEstado }}
                                                            </div>
                                                        </div>
                                                        <div class="form-group" id="div_id_totalPerforado">
                                                            {{ formreporteoperacional.totalPerforado.label_tag }}
                                                            {{ formreporteoperacional.totalPerforado }}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="card-body">
                                                        <div style="display: flex;justify-content: space-between;">
                                                            <h4 class="card-title">Detalle Perforación</h4>
                                                            <p id="datosBarra">N° Barra Anterior: N/A | Largo Barra Anterior: N/A | Contra Anterior: N/A</p>
                                                        </div>
                                                    </div>
                                                    <div class="table-responsive">
                                                        <table id="datatable-perforacion" class="table border text-nowrap text-md-nowrap" style="width:100%">
                                                            <thead>
                                                                <tr>
                                                                    <th>Diam.</th>
                                                                    <th>Perfo.</th>
                                                                    <th>Desde</th>                            
                                                                    <th>Hasta</th>                            
                                                                    <th>Recup</th>                            
                                                                    <th>Recup %</th>
                                                                    <th>Barra</th>
                                                                    <th>Largo B.</th>
                                                                    <th>Total Hta</th>
                                                                    <th>Contra</th>
                                                                    <th>Terreno</th>
                                                                    <th>Orient</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                            </tbody>                    
                                                        </table>
                                                        <div class="row row-sm" style="display: ruby-text;;margin-left: 15px;margin-top: 20px;">
                                                            <div class="col-sm-10 col-md-4">
                                                                {% if reporte.progreso != 'Aprobado' and reporte.progreso != 'Eliminado' %}
                                                                <button type="button" id="eliminarPerforacion" class="btn btn-secondary">Eliminar</button>
                                                                <button type="button" id="agregarPerforacion" class="btn btn-primary">Agregar</button>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="card-body">
                                                        <h4 class="card-title">Control Horario</h4>
                                                    </div>
                                                    <div class="table-responsive">
                                                        <table id="datatable-controlhorario" class="table border text-nowrap text-md-nowrap" style="width:100%">
                                                            <thead>
                                                                <tr>
                                                                    <th class='col-md-2'>Hora Inicio</th>
                                                                    <th class='col-md-2'>Hora Final</th>
                                                                    <th class='col-md-2'>Total Horas:&nbsp;&nbsp;<span id="total-horas-acumuladas">00:00</span></p></th>                            
                                                                    <th class='col-md-6'>Detalle</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                            </tbody> 
                                                        </table>
                                                        <div class="row row-sm" style="display: ruby-text;;margin-left: 15px;margin-top: 20px;">
                                                            <div class="col-sm-10 col-md-4">
                                                                {% if reporte.progreso != 'Aprobado' and reporte.progreso != 'Eliminado' %}
                                                                <button type="button" id="eliminarHorario" class="btn btn-secondary">Eliminar</button>
                                                                <button type="button" id="agregarHorario" class="btn btn-primary">Agregar</button>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row row-sm">
                                                        <div class="col-lg-4 col-xl-4 col-md-4 col-sm-4">
                                                            <div class="card box-shadow-0"> 
                                                                <div class="card-body">
                                                                    <h4 class="card-title">Control de Insumos</h4>
                                                                    <div class="row row-sm">
                                                                        {{ forminsumos|crispy }}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-4 col-xl-4 col-md-4 col-sm-4">
                                                            <div class="card box-shadow-0"> 
                                                                <div class="card-body">
                                                                    <h4 class="card-title">Longitud de Pozo</h4>
                                                                    <div class="row row-sm">
                                                                        {{ formlongitudpozo|crispy }}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-4 col-xl-4 col-md-4 col-sm-4">
                                                            <div class="card box-shadow-0"> 
                                                                <div class="card-body">
                                                                    <h4 class="card-title">Aditivos</h4>
                                                                    <div class="row row-sm">
                                                                        <table id="datatable-aditivos" class="display nowrap" style="width:100%">
                                                                            <thead>
                                                                                <tr>
                                                                                    <th class='col-md-8'>Detalle</th>
                                                                                    <th class='col-md-4'>Cant. Sacos</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                            </tbody> 
                                                                        </table>
                                                                        <div class="row row-sm" style="display: ruby-text;;margin-left: 15px;margin-top: 20px;">
                                                                            <div class="col-sm-10 col-md-10">
                                                                                {% if reporte.progreso != 'Aprobado' and reporte.progreso != 'Eliminado' %}
                                                                                <button type="button" id="eliminarAditivo" class="btn btn-secondary">Eliminar</i></button>
                                                                                <button type="button" id="agregarAditivo" class="btn btn-primary">Agregar</button>
                                                                                {% endif %}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <h4 class="card-title">Observaciones</h4>
                                                    <div class="row row-sm">
                                                        {{ formobservaciones|crispy }}
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>                
                                </div>
                            </div>
                            <div class="tab-pane" id="tab27">
                                <div class="row row-sm">
                                    <div class="col-lg-12 col-xl-12 col-md-12 col-sm-12">
                                        <div class="card box-shadow-0">                        
                                            <div class="card-body">
                                                <h4 class="card-title">Checklist Salida</h4>
                                                <p class="card-title">Atención: una vez creado no podrás eliminar este registro</p>
                                                <form class="form-horizontal" id="formChecklistSalida" action="#" method="POST">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="origin" value="{{origen}}">
                                                    <input type="hidden" name="id" value="{{id_checklist}}">
                                                    <div class="card box-shadow-0">
                                                        <div class="card-body">
                                                            <div class="row row-sm">
                                                                {{ formFinal|crispy }}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card box-shadow-0">
                                                        <div class="card-body">
                                                            <div class="row row-sm">
                                                                <div class="form-group" style="display: flex;">
                                                                    <h5 class="col-md-3">Item</h5>
                                                                    <h5 class="col-md-2">Cantidad</h5>
                                                                </div>
                                                                {% if checklistSalida %}
                                                                    {% for check in checklistSalida %}
                                                                        <div class="form-group" style="display: flex;">
                                                                            <label class="col-md-3">{{check.item}}</label>
                                                                            <input type="number" name="cantidad_{{ check.id }}" min="0" value="{{check.cantidad}}" class="form-control col-md-2" {% if reporte.progreso == 'Aprobado' or reporte.progreso == 'Eliminado' %}disabled{% endif %}>
                                                                        </div>
                                                                    {% endfor %}
                                                                {% else %}
                                                                    {% for material in materialesSonda %}
                                                                        <div class="form-group" style="display: flex;">
                                                                            <label class="col-md-3">{{ material.material }}</label>
                                                                            <input type="number" name="cantidad_{{ material.id }}" min="0" class="form-control col-md-2" {% if reporte.progreso == 'Aprobado' or reporte.progreso == 'Eliminado' %}disabled{% endif %}>
                                                                        </div>
                                                                    {% endfor %}
                                                                {% endif %}
                                                                {% if not es_solo_lectura %}
                                                                <p style="margin-top: 10px; font-style: italic;">Cantidades vacías serán autocompletadas con ceros</p>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>  
                                        </div>
                                    </div>                
                                </div> 
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</form>
{% endblock content %}

{% block javascript %}
<script type="text/javascript">
    document.getElementById('div_id_fecha_checklist_entrada').classList.add('col-md-4');
    document.getElementById('div_id_turno_entrada').classList.add('col-md-4');
    document.getElementById('div_id_jornada_entrada').classList.add('col-md-4');
    document.getElementById('div_id_sonda_entrada').classList.add('col-md-4');
    document.getElementById('div_id_sondaje_entrada').classList.add('col-md-4');
    document.getElementById('div_id_serie_entrada').classList.add('col-md-2');
    document.getElementById('div_id_estado_entrada').classList.add('col-md-2');
    document.getElementById('div_id_fechacreacion').classList.add('col-md-4');
    document.getElementById('div_id_perforista').classList.add('col-md-4');
    document.getElementById('div_id_metroInicial').classList.add('col-md-4');
    document.getElementById('div_id_turno').classList.add('col-md-4');
    document.getElementById('div_id_sonda').classList.add('col-md-4');
    document.getElementById('div_id_metroFinal').classList.add('col-md-4');
    document.getElementById('div_id_controlador').classList.add('col-md-4');
    document.getElementById('div_id_sondaje').classList.add('col-md-4');
    document.getElementById('div_id_totalPerforado').classList.add('col-md-4');
    document.getElementById('div_id_fecha_checklist_salida').classList.add('col-md-4');
    document.getElementById('div_id_turno_salida').classList.add('col-md-4');
    document.getElementById('div_id_jornada_salida').classList.add('col-md-4');
    document.getElementById('div_id_sonda_salida').classList.add('col-md-4');
    document.getElementById('div_id_sondaje_salida').classList.add('col-md-4');
    document.getElementById('div_id_serie_salida').classList.add('col-md-2');
    document.getElementById('div_id_estado_salida').classList.add('col-md-2');
</script>
<script src="{% static 'js/checkchanged.js'%}"></script>
<script src="{% static 'js/jquery-3.7.0.js'%}"></script>
<script src="{% static 'js/jquery.dataTables.min1.13.7.js'%}"></script>
<script src="{% static 'js/dataTables.responsive.min2.5.0.js'%}"></script>

<script type="text/javascript">
    $(document).ready(function() {
        // Variables para controlar el flujo de guardado entre pestañas
        let pendingTabTarget = null;
        let isTabSwitchSave = false;

        // -------------------------------------------------------------
        // LOGICA DE DETECCIÓN DE CAMBIOS (Extension de checkchanged.js)
        // -------------------------------------------------------------
        
        // Al obtener el foco, guardamos el valor original si no existe
        $(document).on('focusin', 'input, select, textarea', function(){
            if(this.dataset.value === undefined){
                this.dataset.value = this.value;
            }
        });

        // Al cambiar, comparamos con el original
        $(document).on('change input', 'input, select, textarea', function(){
            // Para elementos nuevos, asumimos valor original vacio si no se seteó en focusin
            if(this.dataset.value === undefined){
                 this.dataset.value = this.defaultValue || ""; 
            }
            
            if(this.value !== this.dataset.value){
                $(this).addClass('changed');
            } else {
                $(this).removeClass('changed');
            }
        });
        
        // Marcar como cambiado también si se agregan o eliminan filas
        $('#agregarPerforacion, #eliminarPerforacion, #agregarHorario, #eliminarHorario, #agregarAditivo, #eliminarAditivo').on('click', function() {
            // Marcamos el formulario correspondiente como cambiado (aunque checkchanged usa inputs, esto ayuda si validamos forms)
            $('#formReporte').addClass('changed'); 
        });

        // -------------------------------------------------------------
        // FUNCION PARA RESTAURAR VALORES (DESCARTAR CAMBIOS)
        // -------------------------------------------------------------
        function restoreTabChanges() {
            // Buscar la pestaña que está visible en este momento
            const activeTab = $('.tab-pane.active'); 
            
            // Buscar solo los inputs que tengan la clase .changed DENTRO de la pestaña activa
            activeTab.find('.changed').each(function() {
                const originalValue = this.dataset.value;
                
                if (originalValue !== undefined) {
                    // Restaurar el valor del input/select
                    $(this).val(originalValue);
                    
                    // Si es un Select2, necesitamos disparar el evento para que se actualice visualmente
                    if ($(this).hasClass('select2-hidden-accessible')) {
                        $(this).trigger('change'); 
                    }
                }
                
                // Quitar la marca de modificado
                $(this).removeClass('changed');
            });
        }

        // -------------------------------------------------------------
        // INTERCEPTOR DE CAMBIO DE PESTAÑA
        // -------------------------------------------------------------
        $('a[data-bs-toggle="tab"]').on('show.bs.tab', function (e) {
            // Verificar si hay algún elemento con la clase 'changed' en la pestaña actual
            const activeTab = $('.tab-pane.active');
            const hasUnsavedChanges = activeTab.find('.changed').length > 0;

            const canSave = $('#saveButton').length > 0;

            if (hasUnsavedChanges && !isTabSwitchSave && canSave) {
                e.preventDefault(); // Detener el cambio de pestaña
                pendingTabTarget = e.target; // Guardar la pestaña destino

                // Determinar nombre de la pestaña actual para el mensaje
                const activeTabId = $('.nav-link.active').attr('id');
                let currentTabName = '';
                if (activeTabId === 'nav25') currentTabName = 'Checklist Entrada';
                else if (activeTabId === 'nav26') currentTabName = 'Reporte Digital';
                else if (activeTabId === 'nav27') currentTabName = 'Checklist Salida';

                Swal.fire({
                    title: '¡Cambios sin Guardar!',
                    html: `Tienes cambios pendientes en <b>${currentTabName}</b>`,
                    icon: 'warning',
                    showDenyButton: true,
                    showCancelButton: true,
                    confirmButtonText: 'Guardar y Continuar',
                    denyButtonText: 'Descartar Cambios',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: '#ff00d9',
                    denyButtonColor: '#d33',
                    cancelButtonColor: '#6c757d',
                    allowOutsideClick: false
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Opción: Guardar
                        isTabSwitchSave = true;
                        $('#saveButton').click();
                    } else if (result.isDenied) {
                        // Opción: Descartar (Restaurar valores)
                        restoreTabChanges();
                        // Forzar el cambio a la pestaña pendiente
                        $(pendingTabTarget).tab('show'); 
                        pendingTabTarget = null;
                    }
                    // Opción: Cancelar (no hace nada, se queda en la pestaña actual)
                });
            } else {
                isTabSwitchSave = false;
            }
        });

        // -------------------------------------------------------------
        // LOGICA DE GUARDADO
        // -------------------------------------------------------------
        $("#saveButton").on("click", function (event) {
            event.preventDefault(); 

            const existe_reporte = '{{ existe_reporte|safe }}';
            const existe_checklist_salida = '{{ existe_checklist_salida|safe }}';
            
            const activeTab = document.querySelector(".nav-link.active").id;
            let form = null;
            let urlAccion = null;
        
            if (activeTab === "nav25") {
                form = document.querySelector('#formChecklistEntrada');
                urlAccion = '{% url 'save_edit_checklist_materiales_sonda_entrada' %}';
            } else if (activeTab === "nav26") {
                form = document.querySelector('#formReporte');
                if (existe_reporte === "Existe") {
                    urlAccion = '{% url 'save_editar_reporte_digital' %}';
                } else {
                    urlAccion = '{% url 'save_reporte_digital' %}';
                }
            } else if (activeTab === "nav27") {
                form = document.querySelector('#formChecklistSalida');
                if (existe_checklist_salida === "Existe") {
                    urlAccion = '{% url 'save_edit_checklist_materiales_sonda_salida' %}';
                } else {
                    urlAccion = '{% url 'save_checklist_materiales_sonda_salida' %}';
                }
            }

            if (form && urlAccion) {
                const formData = new FormData(form);
                $.LoadingOverlay("show");
                $.ajax({
                    url: urlAccion,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        $.LoadingOverlay("hide");
                        
                        if (form) {
                                $(form).find('input, select, textarea').each(function() {
                                    // Actualizamos el data-value al valor que acabamos de guardar
                                    this.dataset.value = this.value; 
                                    // Quitamos la marca de modificado
                                    $(this).removeClass('changed');
                                });
                            }
                        Swal.fire({
                            icon: 'success',
                            title: 'Reporte Actualizado con éxito!',
                            confirmButtonColor: '#ff00d9',
                        }).then(() => {
                            if (isTabSwitchSave && pendingTabTarget) {
                                $(pendingTabTarget).tab('show'); 
                                isTabSwitchSave = false;
                                pendingTabTarget = null;
                            } else {
                                let redirectUrl = '';
                                const origen = "{{ origen }}";
                                
                                if (origen === 'my_report') {
                                    redirectUrl = '{% url 'manage_mis_reportes_digitales' %}';
                                } else if (origen === 'check_report') {
                                    redirectUrl = '{% url 'manage_revisar_reportes_digitales' %}';
                                } else if (origen === 'all_report') {
                                    redirectUrl = '{% url 'manage_todos_reportes_digitales' %}';
                                } else {
                                    redirectUrl = '{% url 'dashboardSondaje' %}';
                                }
                                window.location.href = redirectUrl;
                            }
                        });
                    },
                    error: function(error) {
                        $.LoadingOverlay("hide");
                        isTabSwitchSave = false;
                        Swal.fire({
                            icon: 'error',        
                            titleText: error.responseJSON ? error.responseJSON.titleText : 'Error',
                            text: error.responseJSON ? error.responseJSON.text : 'Ocurrió un error inesperado',  
                            confirmButtonColor: 'rgb(233, 132, 177)',
                        })
                    }
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo identificar el formulario o la URL correspondiente.',
                    confirmButtonColor: '#ff00d9',
                });
            }
        });
    });
</script>
<script type="application/javascript">// INIT DATATABLE ADITIVOS
    new DataTable('#datatable-aditivos', {
        columnDefs: [
            {
                className: 'dtr-control',
                orderable: false,
                targets: 2
            }
        ],
        language: {
            url: '{% static 'json/es-CL.json' %}',        
        },
        columnDefs: [    
            { searchable: false, targets: [0,1] },
            { orderable: false, targets: [0,1]}  
        ],
        paging: false,
        info: false, 
        lengthChange: false,
        searching: false,    
        ordering: false,
        lengthMenu: [[15, 30], [15, 30]],
        /*order: [1, 'desc'],*/
        responsive: {
            details: {
                type: 'column'
            }
        }
    });
</script>
<script>// DATATABLE PERFORACION
    let ultimoRegistro = {};
    $(document).ready(function() {
        const reporteProgreso = "{{ reporte.progreso }}";
        const esSoloLectura = (reporteProgreso === 'Aprobado' || reporteProgreso === 'Eliminado');
        const disabledAttr = esSoloLectura ? 'disabled' : '';

        const existe_reporte = '{{ existe_reporte|safe }}';
        function obtenerMetroInicial() {

            const sondajeCodigo = '{{ sondajeCodigo }}';
            const sondajeSerie = '{{ sondajeSerie }}';
            const sondajeEstado = '{{ sondajeEstado }}';
            const id_checklist = '{{ id_checklist }}';
            
            //console.log(sondajeCodigo, sondajeSerie, sondajeEstado);
            if (sondajeCodigo && sondajeSerie) {
                $.LoadingOverlay("show");
                $.ajax({
                    url: "{% url 'obtener_metro_inicial' %}",
                    method: 'GET',
                    data: {
                        'sondajeCodigo': sondajeCodigo,
                        'sondajeSerie': sondajeSerie,
                        'sondajeEstado': sondajeEstado,
                        'id_checklist': id_checklist,
                    },
                    dataType: 'json',
                    success: function(response) {
                        $.LoadingOverlay("hide");
                        ultimoRegistro = response;
                        console.log(response);
                        var metroInicial = parseFloat(response.reporte.metroInicial) || 0;
                        var metroFinal = parseFloat(response.reporte.metroFinal) || 0;
                        var reporteIdChecklist = parseFloat(response.reporte.id_checklist) || 0;
                        largoBarril = parseFloat(response.longitudPozo.largoBarril) || 0;
                        puntoMuerto = parseFloat(response.longitudPozo.puntoMuerto) || 0;
                        var contra = parseFloat(response.perforacion.contra) || 0;
                        const existe_reporte_anterior = !!response.existe_reporte_anterior;
                        
                        if (reporteIdChecklist == id_checklist){
                            $('#id_metroInicial').val(metroInicial.toFixed(2));
                        }else{
                            $('#id_metroInicial').val(metroFinal.toFixed(2));
                        }
                        
                        if (existe_reporte === "No Existe") {
                            if (existe_reporte_anterior) {
                                $('#id_corona').val(response.insumos.corona);
                                $('#id_escareador').val(response.insumos.escareador);
                                $('#id_cantidadAgua').val(response.insumos.cantidadAgua);
                                $('#id_casing').val(response.insumos.casing);
                                $('#id_zapata').val(response.insumos.zapata);
                            }
                            $('#id_largoBarril').val(largoBarril.toFixed(2));
                            $('#id_puntoMuerto').val(puntoMuerto.toFixed(2));
                        }                        
                        
                        if (!existe_reporte_anterior) {
                            document.getElementById('datosBarra').innerText = 'N° Barra Anterior: N/A | Largo Barra Anterior: N/A | Contra Anterior: N/A';
                        } else {
                            const barra = response.perforacion?.barra || 0;
                            const largoBarraPrev = response.perforacion?.largoBarra || 0;
                            const contraAnterior = response.perforacion?.contra || 0;
                            document.getElementById('datosBarra').innerText = `N° Barra Anterior: ${barra} | Largo Barra Anterior: ${largoBarraPrev} | Contra Anterior: ${contraAnterior}`;
                        }
                    },
                    error: function(xhr, status, error) {
                        $.LoadingOverlay("hide");
                        alert('Ocurrió un error al obtener los datos.');
                    }
                });
            } else {
                alert("Debe ingresar tanto el código como la serie del sondaje.");
            }
        }
        console.log(existe_reporte);
        

        $('#id_sondajeCodigo, #id_sondajeSerie, #id_sondajeEstado').on('change', obtenerMetroInicial);

        if (existe_reporte === "Existe") {
            obtenerMetroInicial();
            $('#id_sondajeCodigo, #id_sondajeSerie, #id_sondajeEstado').on('change', obtenerMetroInicial);
            let rowCount = 0;
            const reporteDetallePerforacion = JSON.parse('{{ reporte_detalle_perforacion|safe }}');

            function updateSummaryFieldsData() {
                let maxHasta = 0;
                let maxBarras = 0;
                let maxContra = 0;
                let maxLargoBarra = 0;
                let newRestoBarra = 0;

                $('#datatable-perforacion tbody tr').each(function() {
                    const $row = $(this);
                    const hasta = parseFloat($row.find('input[name^="hasta_"]').val()) || 0;
                    const barras = parseFloat($row.find('input[name^="barra_"]').val()) || 0;
                    const contra = parseFloat($row.find('input[name^="contra_"]').val()) || 0;
                    const largoBarra = parseFloat($row.find('input[name^="largoBarra_"]').val()) || 0;

                    if (hasta > maxHasta) maxHasta = hasta;
                    if (barras > maxBarras) maxBarras = barras;
                    if (largoBarra > maxLargoBarra) maxLargoBarra = largoBarra;
                    //if (contra > maxContra) maxContra = contra;
                    maxContra = contra;
                });
                
                newRestoBarra = Math.max(maxContra - maxLargoBarra, 0);

                $('#id_longitudPozo').val(maxHasta.toFixed(2));
                $('#id_numeroBarras').val(maxBarras);
                $('#id_restoBarra').val(newRestoBarra.toFixed(2));
                $('#id_metroFinal').val(maxHasta.toFixed(2));
                $('#id_totalPerforado').val((maxHasta - parseFloat($('#id_metroInicial').val())).toFixed(2));
            }

            function updateFieldsData() {
                const largoBarril = parseFloat($('#id_largoBarril').val()) || 0;
                const puntoMuerto = parseFloat($('#id_puntoMuerto').val()) || 0;
                const largoBarra = parseFloat($('#id_largoBarra').val()) || 0;
                let barraAnterior = 0;
                let contraAnterior = 0;
                let perforadoAnterior = 0;
                let lastHasta = parseFloat($('#id_metroInicial').val()) || 0;

                $('#datatable-perforacion tbody tr').each(function(index) {
                    const $row = $(this);
                    const perforado = parseFloat($row.find('input[name^="perforado_"]').val()) || 0;
                    const recuperacion = parseFloat($row.find('input[name^="recuperacion_"]').val()) || 0;
                    const porcentaje = parseFloat($row.find('input[name^="porcentajeRecuperacion_"]').val()) || 0;
                    const barra = parseFloat($row.find('input[name^="barra_"]').val()) || 0;
                    const largoBarra = parseFloat($row.find('input[name^="largoBarra_"]').val()) || 0;
                    
                    $row.find('input[name^="porcentajeRecuperacion_"]').val(porcentaje.toFixed(2));
                    
                    // Actualizar campo 'desde' con el 'hasta' anterior
                    $row.find('input[name^="desde_"]').val(lastHasta.toFixed(2));
            
                    // Calcular 'hasta' basado en el valor de 'desde' y 'perforado'
                    const hastaActual = lastHasta + perforado;
                    $row.find('input[name^="hasta_"]').val(hastaActual.toFixed(2));

                    const ultimoHasta = lastHasta; 
                    // Actualizar 'lastHasta' para la siguiente fila
                    lastHasta = hastaActual;

                    
                    // Validar y calcular porcentaje de recuperación
                    if (perforado === 0) {
                        $row.find('input[name^="porcentajeRecuperacion_"]').val('0.00');
                        $row.removeClass('fila-error');
                    } else if (recuperacion <= perforado) {
                        $row.removeClass('fila-error');
                        const porcentajeRecuperacion = (recuperacion / perforado) * 100;
                        $row.find('input[name^="porcentajeRecuperacion_"]').val(porcentajeRecuperacion.toFixed(2));
                    } else  {
                        //alert('La recuperación no puede ser mayor que el valor de Perforado.');
                        //$row.find('input[name^="recuperacion_"]').val(perforado.toFixed(2));
                        //$row.find('input[name^="porcentajeRecuperacion_"]').val('1000');
                        $row.addClass('fila-error');
                    }
                    
                    //console.log(ultimoRegistro);
                    console.log("index: ", index);
                    // Si es la primera fila
                    if (index === 0) {
                            const ultimoLargoBarril = parseFloat($('#id_largoBarril').val()) || 0;
                            const ultimoPuntoMuerto = parseFloat($('#id_puntoMuerto').val()) || 0;
                            const ultimoLargoBarra = parseFloat($('#id_largoBarra').val()) || 0;
                            const barraActual = barra || 0;
                            const ultimoHasta = parseFloat($row.find('input[name^="desde_"]').val()) || 0;
        
                            console.log("AQUI 0 Existe");
                            console.log("ultimoregistro",ultimoRegistro);
                            console.log("primerLargoBarril: ", ultimoLargoBarril);
                            console.log("primerPuntoMuerto: ", ultimoPuntoMuerto);
                            console.log("primerLargoBarra: ", ultimoLargoBarra);
                            console.log("primerbarra: ", barraActual);
                            console.log("primerHasta: ", ultimoHasta);
                            
                            
                            const totalHtas = (ultimoLargoBarril - ultimoPuntoMuerto) + (barraActual * largoBarra);
                            const contra = totalHtas - ultimoHasta;
            
                            $row.find('input[name^="totalHtas_"]').val(totalHtas.toFixed(2));
                            $row.find('input[name^="contra_"]').val(contra.toFixed(2));
                    } else {
                        // Para las demás filas
                        console.log("AQUI 1 Existe");
                        const ultimoLargoBarril = largoBarril;
                        const ultimoPuntoMuerto = puntoMuerto;
                        const ultimoLargoBarra = largoBarra;
                        const barraActual = barra || 0;

                        console.log("ultimoregistro",ultimoRegistro);
                        console.log("ultimoLargoBarril: ", ultimoLargoBarril);
                        console.log("ultimoPuntoMuerto: ", ultimoPuntoMuerto);
                        console.log("ultimoLargoBarra: ", ultimoLargoBarra);
                        console.log("ultimobarra: ", barraActual);
                        console.log("ultimoHasta: ", lastHasta);
            
                        const totalHtas = (ultimoLargoBarril - ultimoPuntoMuerto) + (barraActual * ultimoLargoBarra);
                        const contra = totalHtas - ultimoHasta;
            
                        $row.find('input[name^="totalHtas_"]').val(totalHtas.toFixed(2));
                        $row.find('input[name^="contra_"]').val(contra.toFixed(2));
                    }
                    // Actualizar valores de referencia para la siguiente fila
                    barraAnterior = barra;
                    contraAnterior = parseFloat($row.find('input[name^="contra_"]').val()) || 0;
                    perforadoAnterior = perforado;
                });                
                // Actualizar campos resumen
                updateSummaryFieldsData();
            }

            function createRowData(detalle = {}) {
                rowCount++;
                const lastRow = $('#datatable-perforacion tbody tr:last');
                let lastHasta = 0;

                if (lastRow.length > 0) {
                    lastHasta = parseFloat(lastRow.find('input[name^="hasta_"]').val()) || 0;
                }
                const newRowHtml = `
                    <tr>
                        <td class='col-md-1 new-td'>
                            <select id="id_diametros_${rowCount}" name="diametros_${rowCount}" class="form-control" required ${disabledAttr}>
                                {% for diametro in diametros %}
                                    <option value="{{ diametro.id }}" ${detalle.diametros == {{ diametro.id }} ? 'selected' : ''}>{{ diametro.diametro }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class='col-md-1 new-td'><input type="number" step="0.01" id="id_perforado_${rowCount}" name="perforado_${rowCount}" class="form-control perforado-input" autocomplete="off" value="${detalle.perforado || '0.00'}" required ${disabledAttr}></td>
                        <td class='col-md-1 new-td'><input type="number" step="0.01" id="id_desde_${rowCount}" name="desde_${rowCount}" class="form-control" autocomplete="off" value="${lastHasta.toFixed(2)}" readonly></td>
                        <td class='col-md-1 new-td'><input type="number" step="0.01" id="id_hasta_${rowCount}" name="hasta_${rowCount}" class="form-control" autocomplete="off" readonly></td>
                        <td class='col-md-1 new-td'><input type="number" step="0.01" id="id_recuperacion_${rowCount}" name="recuperacion_${rowCount}" class="form-control recuperacion-input" autocomplete="off" value="${detalle.recuperacion || '0.00'}" required ${disabledAttr}></td>
                        <td class='col-md-1 new-td'><input type="number" step="0.01" id="id_porcentajeRecuperacion_${rowCount}" name="porcentajeRecuperacion_${rowCount}" class="form-control" autocomplete="off" readonly></td>
                        <td class='col-md-1 new-td'><input type="number" step="1" min="0" id="id_barra_${rowCount} "name="barra_${rowCount}" class="solo-enteros form-control" inputmode="numeric" autocomplete="off" value="${detalle.barra !== undefined && detalle.barra !== null ? detalle.barra : ''}" ${disabledAttr}></td>
                        <td class='col-md-1 new-td'><input type="number" step="0.01" id="id_largoBarra_${rowCount}" name="largoBarra_${rowCount}" class="form-control" autocomplete="off" value="${detalle.largoBarra || '0.00'}" required ${disabledAttr}></td>
                        <td class='col-md-1 new-td'><input type="number" step="0.01" id="id_totalHtas_${rowCount}" name="totalHtas_${rowCount}" class="form-control" autocomplete="off" readonly></td>
                        <td class='col-md-1 new-td'><input type="number" step="0.01" id="id_contra_${rowCount}" name="contra_${rowCount}" class="form-control" autocomplete="off" readonly></td>
                        <td class='col-md-1 new-td'>
                            <select id="id_tipoTerreno_${rowCount}" name="tipoTerreno_${rowCount}" class="form-control" required ${disabledAttr}>
                                {% for terreno in tipos_terreno %}
                                    <option value="{{ terreno.id }}" ${detalle.tipoTerreno === {{ terreno.id }} ? 'selected' : ''}>{{ terreno.tipoTerreno }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class='col-md-1 new-td'>
                            <select id="id_orientacion_${rowCount}" name="orientacion_${rowCount}" class="form-control" required ${disabledAttr}>
                                {% for orientacion in orientaciones %}
                                    <option value="{{ orientacion.id }}" ${detalle.orientacion === {{ orientacion.id }} ? 'selected' : ''}>{{ orientacion.orientacion }}</option>
                                {% endfor %}
                            </select>
                        </td>
                    </tr>`;
                $('#datatable-perforacion tbody').append(newRowHtml);
            }

            // Crear filas iniciales desde los datos de la vista
            $('#datatable-perforacion tbody').empty();
            reporteDetallePerforacion.forEach(detalle => {
                createRowData(detalle);
            });
            updateFieldsData();

            $('#agregarPerforacion').on('click', function() {
                const lastRow = $('#datatable-perforacion tbody tr:last');
                const isCompletePerforacion = lastRow.find('input').toArray().every(input => input.value.trim() !== '');

                if (isCompletePerforacion) {
                    createRowData();
                } else {
                    alert('Debe completar todos los campos de la fila actual antes de agregar una nueva.');
                }
            });

            $('#eliminarPerforacion').on('click', function() {
                if ($('#datatable-perforacion tbody tr').length > 1) {
                    $('#datatable-perforacion tbody tr:last').remove();
                    updateFieldsData();
                } else {
                    alert('Debe haber al menos una fila en la tabla.');
                }
            });

            $('#datatable-perforacion').on('input', 'input', function() {
                updateFieldsData();
            });

            $('#id_largoBarril, #id_puntoMuerto, #id_largoBarra').on('input', function() {
                updateFieldsData();
            });
        } else {
            obtenerMetroInicial();
            document.getElementById('div_id_turno').classList.add('col-md-4');
            let rowCount = 0;
    
            function updateSummaryFields() {
                let maxHasta = 0;
                let maxBarras = 0;
                let maxContra = 0;
                let maxLargoBarra = 0;
                let newRestoBarra = 0;
    
                $('#datatable-perforacion tbody tr').each(function() {
                    const $row = $(this);
                    const hasta = parseFloat($row.find('input[name^="hasta_"]').val()) || 0;
                    const barras = parseFloat($row.find('input[name^="barra_"]').val()) || 0;
                    const contra = parseFloat($row.find('input[name^="contra_"]').val()) || 0;
                    const largoBarra = parseFloat($row.find('input[name^="largoBarra_"]').val()) || 0;
    
                    if (hasta > maxHasta) maxHasta = hasta;
                    if (barras > maxBarras) maxBarras = barras;
                    if (contra > maxContra) maxContra = contra;
                    if (largoBarra > maxLargoBarra) maxLargoBarra = largoBarra;
                });

                newRestoBarra = Math.max(maxContra - maxLargoBarra, 0);
    
                $('#id_longitudPozo').val(maxHasta.toFixed(2));
                $('#id_numeroBarras').val(maxBarras);
                $('#id_restoBarra').val(newRestoBarra.toFixed(2));
                $('#id_metroFinal').val(maxHasta.toFixed(2));
                $('#id_totalPerforado').val((maxHasta - parseFloat($('#id_metroInicial').val())).toFixed(2));
            }
    
            function updateFields() {
                const largoBarril = parseFloat($('#id_largoBarril').val()) || 0;
                const puntoMuerto = parseFloat($('#id_puntoMuerto').val()) || 0;
                const largoBarra = parseFloat($('#id_largoBarra').val()) || 0;
                let barraAnterior = 0;
                let contraAnterior = 0;
                let perforadoAnterior = 0;
                let desdeAnterior = 0;
                let htaAnterior = 0;
                let lastHasta = parseFloat($('#id_metroInicial').val()) || 0;
            
                $('#datatable-perforacion tbody tr').each(function(index) {
                    const $row = $(this);
                    const perforado = parseFloat($row.find('input[name^="perforado_"]').val()) || 0;
                    const recuperacion = parseFloat($row.find('input[name^="recuperacion_"]').val()) || 0;
                    const barra = parseFloat($row.find('input[name^="barra_"]').val()) || 0;
                    const largoBarra = parseFloat($row.find('input[name^="largoBarra_"]').val()) || 0;
            
                    // Actualizar campo 'desde' con el 'hasta' anterior
                    $row.find('input[name^="desde_"]').val(lastHasta.toFixed(2));
            
                    // Calcular 'hasta' basado en el valor de 'desde' y 'perforado'
                    const hastaActual = lastHasta + perforado;
                    $row.find('input[name^="hasta_"]').val(hastaActual.toFixed(2));
    
                    const ultimoHasta = lastHasta; 
                    // Actualizar 'lastHasta' para la siguiente fila
                    lastHasta = hastaActual;

                    
                    
                    //console.log(perforado);
                    // Validar y calcular porcentaje de recuperación
                    if (perforado === 0) {
                        const porcentajeRecuperacion = 0;
                        $row.removeClass('fila-error');
                        $row.find('input[name^="porcentajeRecuperacion_"]').val(porcentajeRecuperacion.toFixed(2));
                    } else {
                        if (recuperacion <= perforado) {
                            $row.removeClass('fila-error');
                            const porcentajeRecuperacion = (recuperacion / perforado) * 100;
                            $row.find('input[name^="porcentajeRecuperacion_"]').val(porcentajeRecuperacion.toFixed(2));
                        } else {
                            //alert('La recuperación no puede ser mayor que el valor de Perforado.');
                            $row.addClass('fila-error');
                            $row.find('input[name^="recuperacion_"]').val(perforado.toFixed(2));
                            $row.find('input[name^="porcentajeRecuperacion_"]').val('100');
                        }
                    }

                    console.log(ultimoRegistro);
                    
                    let totalHtas = 0;
                    let contra = 0;
                    // Si es la primera fila
                    //console.log(index);
                    if (index === 0) {
                        console.log("AQUI 0 No existe 9");
                        //si no hay registro anterior
                        console.log("BARRA",ultimoRegistro.perforacion.barra );
                        if (ultimoRegistro.perforacion.barra === "" ) {
                            const ultimoLargoBarril = parseFloat($('#id_largoBarril').val()) || 0;
                            const ultimoPuntoMuerto = parseFloat($('#id_puntoMuerto').val()) || 0;
                            const ultimoLargoBarra = parseFloat($('#id_largoBarra').val()) || 0;
                            const barraActual = barra || 0;
                            const ultimoHasta = ultimoRegistro.perforacion.hasta || 0;
                            totalHtas = (ultimoLargoBarril - ultimoPuntoMuerto);
                            contra = totalHtas;
            
                            $row.find('input[name^="totalHtas_"]').val(totalHtas.toFixed(2));
                            $row.find('input[name^="contra_"]').val(contra.toFixed(2));
                        // si hay registro anterior
                        } else {
                            console.log("ELSE AQUI");
                            const ultimoLargoBarril = ultimoRegistro.longitudPozo.largoBarril;
                            const ultimoPuntoMuerto = ultimoRegistro.longitudPozo.puntoMuerto;
                            const ultimoLargoBarra = ultimoRegistro.perforacion.largoBarra;
                            const barraActual = barra || 0;
                            const ultimoHasta = ultimoRegistro.perforacion.hasta;

                            //totalHtas = parseFloat(ultimoRegistro.perforacion.totalHtas);
                            //contra = parseFloat(ultimoRegistro.perforacion.contra);

                            //totalHtas = (ultimoLargoBarril - ultimoPuntoMuerto) + (barraActual * ultimoLargoBarra);
                            //contra = totalHtas - ultimoHasta;
                            

                            console.log("ultimoLargoBarril", ultimoLargoBarril);
                            console.log("ultimoPuntoMuerto", ultimoPuntoMuerto);
                            console.log("ultimoLargoBarra", ultimoLargoBarra);
                            console.log("barraActual", barraActual);
                            console.log("ultimoHasta", ultimoHasta);
                            console.log("totalHtas", totalHtas);
                            console.log("contra", contra);

                            console.log("ULTIMOREGISTRO", ultimoRegistro);
                            
                            if (barraActual === 0 && ultimoRegistro.perforacion.barra === 0 ) {
                                LargoBarrilActual = parseFloat($('#id_largoBarril').val()) || 0;
                                PuntoMuertoActual = parseFloat($('#id_puntoMuerto').val()) || 0;
                                totalHtas = (LargoBarrilActual - PuntoMuertoActual);
                                

                            } else if (barraActual > ultimoRegistro.perforacion.barra) {
                                LargoBarraActual = parseFloat($row.find('input[name^="largoBarra_"]').val()) || 0;
                                console.log("LargoBarraActual", LargoBarraActual);
                                //totalHtas =  parseFloat(ultimoRegistro.perforacion.totalHtas) + parseFloat(ultimoRegistro.perforacion.largoBarra);
                                //totalHtas =  parseFloat(ultimoRegistro.perforacion.totalHtas) + parseFloat(LargoBarraActual);
                                totalHtas = (ultimoLargoBarril - ultimoPuntoMuerto) + (barraActual * ultimoLargoBarra);
                                
                            } else {
                                totalHtas =  parseFloat(ultimoRegistro.perforacion.totalHtas);
                            }

                            const diferencia = +(ultimoRegistro.perforacion.contra - ultimoRegistro.perforacion.perforado).toFixed(2);
                            
                            if (barraActual === 0 && ultimoRegistro.perforacion.barra === 0 ) {
                                contra = totalHtas;

                            }else if (diferencia < perforado) {
                                LargoBarraActual = parseFloat($row.find('input[name^="largoBarra_"]').val()) || 0;
                                contra = parseFloat(diferencia) + parseFloat(LargoBarraActual);

                            } else {
                                contra = parseFloat(diferencia);
                            }
                            
                            barraAnterior = ultimoRegistro.perforacion.barra;
                            largoBarraAnterior = ultimoRegistro.perforacion.largoBarra;
                            //$row.find('input[name^="barra_"]').attr('placeholder', `**${barraAnterior}**`);
                            //$row.find('input[name^="largoBarra_"]').attr('placeholder', `**${largoBarraAnterior}**`);
                            $row.find('input[name^="totalHtas_"]').val(totalHtas.toFixed(2));
                            $row.find('input[name^="contra_"]').val(contra.toFixed(2));
                        }
                    } else {
                        console.log("AQUI 1 No existe");
                        // Para las demás filas
                        const ultimoLargoBarril = largoBarril;
                        const ultimoPuntoMuerto = puntoMuerto;
                        const ultimoLargoBarra = largoBarra;
                        const barraActual = barra || 0;

                        if (barraActual > barraAnterior) {
                            totalHtas = totalHtasAnterior + ultimoLargoBarra;
                        } else {
                            totalHtas = totalHtasAnterior;
                        }
                                        
                        const diferencia = +(contraAnterior - perforadoAnterior).toFixed(2);
                        if (diferencia < perforado) {
                            contra = diferencia + largoBarra;
                        } else {
                            contra = diferencia;
                        }            
                        //totalHtas = (ultimoLargoBarril - ultimoPuntoMuerto) + (barraActual * ultimoLargoBarra);
                        //contra = totalHtas - ultimoHasta;
            
                        $row.find('input[name^="totalHtas_"]').val(totalHtas.toFixed(2));
                        $row.find('input[name^="contra_"]').val(contra.toFixed(2));
                    }
                    // Actualizar valores de referencia para la siguiente fila
                    barraAnterior = barra;
                    totalHtasAnterior = totalHtas;
                    contraAnterior = parseFloat($row.find('input[name^="contra_"]').val()) || 0;
                    desdeAnterior = parseFloat($row.find('input[name^="desde_"]').val()) || 0;
                    perforadoAnterior = perforado;
                });
                // Actualizar campos resumen
                updateSummaryFields();
            }
            
            function createRow(metroInicial = 0) {
                rowCount++;
                let lastHasta = metroInicial;
    
                const lastRow = $('#datatable-perforacion tbody tr:last');
                if (lastRow.length > 0) {
                    lastHasta = parseFloat(lastRow.find('input[name^="hasta_"]').val()) || metroInicial;
                    lastHasta = lastHasta.toFixed(2);
                }
    
                const newRowHtml = `
                    <tr>
                        <td class='col-md-1 new-td'>
                            <select id="id_diametros_${rowCount}" name="diametros_${rowCount}" class="form-control" required ${disabledAttr}>
                                {% for diametro in diametros %}
                                    <option value="{{ diametro.id }}">{{ diametro.diametro }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class='col-md-1 new-td'><input type="number" step="0.01" id="id_perforado_${rowCount}" name="perforado_${rowCount}" class="form-control perforado-input" autocomplete="off" required ${disabledAttr}></td>
                        <td class='col-md-1 new-td'><input type="number" step="0.01" id="id_desde_${rowCount}" name="desde_${rowCount}" class="form-control" autocomplete="off" value="${lastHasta}" readonly></td>
                        <td class='col-md-1 new-td'><input type="number" step="0.01" id="id_hasta_${rowCount}" name="hasta_${rowCount}" class="form-control" autocomplete="off" readonly></td>
                        <td class='col-md-1 new-td'><input type="number" step="0.01" id="id_recuperacion_${rowCount}" name="recuperacion_${rowCount}" class="form-control recuperacion-input" autocomplete="off" required ${disabledAttr}></td>
                        <td class='col-md-1 new-td'><input type="number" step="0.01" id="id_porcentajeRecuperacion_${rowCount}" name="porcentajeRecuperacion_${rowCount}" class="form-control" autocomplete="off" readonly></td>
                        <td class='...'><input type="number" step="1" min="0" id="id_barra_${rowCount}" name="barra_${rowCount}" class="solo-enteros form-control" inputmode="numeric" autocomplete="off" ... ${disabledAttr}></td>
                        <td class='col-md-1 new-td'><input type="number" step="0.01" id="id_largoBarra_${rowCount}" name="largoBarra_${rowCount}" class="form-control" autocomplete="off" required ${disabledAttr}></td>
                        <td class='col-md-1 new-td'><input type="number" step="0.01" id="id_totalHtas_${rowCount}" name="totalHtas_${rowCount}" class="form-control" autocomplete="off" readonly></td>
                        <td class='col-md-1 new-td'><input type="number" step="0.01" id="id_contra_${rowCount}" name="contra_${rowCount}" class="form-control" autocomplete="off" readonly></td>
                        <td class='col-md-1 new-td'>
                            <select id="id_tipoTerreno_${rowCount}" name="tipoTerreno_${rowCount}" class="form-control" required ${disabledAttr}>
                                {% for terreno in tipos_terreno %}
                                    <option value="{{ terreno.id }}">{{ terreno.tipoTerreno }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class='col-md-1 new-td'>
                            <select id="id_orientacion_${rowCount}" name="orientacion_${rowCount}" class="form-control" required ${disabledAttr}>
                                {% for orientacion in orientaciones %}
                                    <option value="{{ orientacion.id }}">{{ orientacion.orientacion }}</option>
                                {% endfor %}
                            </select>
                        </td>
                    </tr>`;
                $('#datatable-perforacion tbody').append(newRowHtml);
            }
    
            let metroInicial = parseFloat($('#id_metroInicial').val()) || 0;
            $('#datatable-perforacion tbody').empty();
            createRow(metroInicial);
    
            $('#agregarPerforacion').on('click', function() {
                const lastRow = $('#datatable-perforacion tbody tr:last');
                const isCompletePerforacion = lastRow.find('input').toArray().every(input => input.value.trim() !== '');
    
                if (isCompletePerforacion) {
                    createRow();
                } else {
                    alert('Debe completar todos los campos de la fila actual antes de agregar una nueva.');
                }
            });
    
            $('#eliminarPerforacion').on('click', function() {
                if ($('#datatable-perforacion tbody tr').length > 1) {
                    $('#datatable-perforacion tbody tr:last').remove();
                    updateFields();
                } else {
                    alert('Debe haber al menos una fila en la tabla.');
                }
            });
    
            $('#datatable-perforacion').on('input', 'input', function() {
                updateFields();
            });
    
            $('#id_largoBarril, #id_puntoMuerto, #id_largoBarra').on('input', function() {
                updateFields();
            });
        }
    });
    
</script>
<script>//QUEDA HTS EN POZO Y CANTIDAD
    $(document).ready(function() {
        const selectHtaEnPozo = document.getElementById('id_htaEnPozo');
        const inputMtsDeHta = document.getElementById('id_mtsDeHta');
        const inputProfundidadHta = document.getElementById('id_profundidadHta');

        function updateInputState() {
            if (selectHtaEnPozo.value === 'No') {
                inputMtsDeHta.value = "0.00";
                inputProfundidadHta.value = "0.00";
                inputMtsDeHta.readOnly = true;
                inputProfundidadHta.readOnly = true;
            } else {
                inputMtsDeHta.readOnly = false;
                inputProfundidadHta.readOnly = false;
            }
        }
        selectHtaEnPozo.addEventListener('change', updateInputState);
        window.addEventListener('load', updateInputState);
    });
</script>
<script>//DATATABLE ADITIVOS
    $(document).ready(function() {
        const reporteProgreso = "{{ reporte.progreso }}";
        const esSoloLectura = (reporteProgreso === 'Aprobado' || reporteProgreso === 'Eliminado');
        const disabledAttr = esSoloLectura ? 'disabled' : '';

        const existe_reporte = '{{ existe_reporte|safe }}';
        if (existe_reporte === "Existe") {
            let rowCount = 0;

            // Obtener datos desde el JSON proporcionado por la vista
            const reporteDetalleAditivos = JSON.parse('{{ reporte_detalle_aditivos|escapejs }}');

            function createRow(aditivoId = null, cantidad = '') {
                rowCount++;
                const newRowHtml = `
                    <tr>
                        <td class='col-md-7'>
                            <select id="id_aditivo_${rowCount}" name="aditivo_${rowCount}" class="form-control" required ${disabledAttr}>
                                {% for aditivo in aditivos %}
                                    <option value="{{ aditivo.id }}" ${aditivoId == '{{ aditivo.id }}' ? 'selected' : ''}>{{ aditivo.aditivo }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class='...'><input type="number" step="1" min="0" id="id_cantidad_${rowCount}" name="cantidad_${rowCount}" class="solo-enteros form-control" inputmode="numeric" autocomplete="off" value="${cantidad || ''}" ${disabledAttr}></td>
                    </tr>`;
                $('#datatable-aditivos tbody').append(newRowHtml);
            }
            
            function initializeTable() {
                if (reporteDetalleAditivos.length > 0) {
                    reporteDetalleAditivos.forEach((item) => {
                        createRow(item.aditivo, item.cantidad);
                    });
                } else {
                    
                    //createRow();
                }
            }
            $('#datatable-aditivos tbody').empty();
            initializeTable();

            $('#agregarAditivo').on('click', function() {
                if (rowCount === 0) {
                    $('#datatable-aditivos tbody').empty();
                }
                const lastRow = $('#datatable-aditivos tbody tr:last');
                const isCompleteAditivos = lastRow.find('input').toArray().every(input => input.value.trim() !== '');
                if (isCompleteAditivos) {
                    createRow();
                } else {
                    alert('Completa todos los campos antes de agregar una nueva fila.');
                }
            });

            $('#eliminarAditivo').on('click', function() {
                const rowCount = $('#datatable-aditivos tbody tr').length;
                if (rowCount > 0) {
                    $('#datatable-aditivos tbody tr:last').remove();
                } else {
                    alert('No hay filas que eliminar.');
                }
            });
        } else {
            let rowCount = 0;
            function createInitialRow() {
                rowCount++;
                const newRowHtml = `
                    <tr>
                        <td class='col-md-8'>
                            <select id="id_aditivo_${rowCount}" name="aditivo_${rowCount}" class="form-control" required>
                                {% for aditivo in aditivos %}
                                    <option value="{{ aditivo.id }}">{{ aditivo.aditivo }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class='...'><input type="number" step="1" min="0" id="id_cantidad_${rowCount}" name="cantidad_${rowCount}" class="solo-enteros form-control" inputmode="numeric" autocomplete="off" ...></td>
                    </tr>`;
                $('#datatable-aditivos tbody').append(newRowHtml);

            }
            $('#datatable-aditivos tbody').empty();
            //createInitialRow();
            $('#agregarAditivo').on('click', function() {
                const lastRow = $('#datatable-aditivos tbody tr:last');
                const isCompleteAditivos = lastRow.find('input').toArray().every(input => input.value.trim() !== '');
                if (isCompleteAditivos) {
                    rowCount++;
                    const newRowHtml = `
                        <tr>
                            <td class='col-md-8'>
                                <select id="id_aditivo_${rowCount}" name="aditivo_${rowCount}" class="form-control" required>
                                    {% for aditivo in aditivos %}
                                        <option value="{{ aditivo.id }}">{{ aditivo.aditivo }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td class='...'><input type="number" step="1" min="0" id="id_cantidad_${rowCount}" name="cantidad_${rowCount}" class="solo-enteros form-control" inputmode="numeric" autocomplete="off" ...></td>
                        </tr>`;

                    // Agregar la nueva fila al cuerpo de la tabla
                    $('#datatable-aditivos tbody').append(newRowHtml);
                } else {
                    alert('Completa todos los campos antes de agregar una nueva fila.');
                }
            });
            // Función para eliminar la última fila
            $('#eliminarAditivo').on('click', function() {
                const rowCount = $('#datatable-aditivos tbody tr').length;
                if (rowCount > 0) {
                    $('#datatable-aditivos tbody tr:last').remove();
                } else {
                    alert('No hay filas que eliminar.');
                }
            });
        }
    });
</script>
<script src="{% static 'js/tempus-dominus.min.js'%}" crossorigin="anonymous"></script>
<script src="{% static 'js/moment.min.js'%}"></script>
<script>//CONTROL DE HORARIO CON ELEMENTOS
    document.addEventListener('DOMContentLoaded', function() {
        const reporteProgreso = "{{ reporte.progreso }}";
        const esSoloLectura = (reporteProgreso === 'Aprobado' || reporteProgreso === 'Eliminado');
        const disabledAttr = esSoloLectura ? 'disabled' : '';

        const existe_reporte = '{{ existe_reporte|safe }}';
        if (existe_reporte === "Existe") {
            const options = {
                display: {
                    viewMode: 'calendar',
                    icons: {
                        type: 'icons',
                        up: 'icon-arrow-up',
                        down: 'icon-arrow-down',
                    },
                    components: {
                        calendar: false,
                        minutes: true,
                        seconds: false,
                    },
                },
                stepping: 15,
                localization: {
                    hourCycle: 'h23',
                    dateFormats: {
                        LT: 'HH:mm',
                    },
                    ordinal: (n) => n,
                    format: 'LT',
                }
            };

            let rowCount = 0;

            function disableManualInput(selector) {
                document.querySelectorAll(selector).forEach(input => {
                    input.addEventListener('keypress', (e) => e.preventDefault());  // Previene escribir
                    input.addEventListener('keydown', (e) => e.preventDefault());    // Previene usar teclas
                    input.addEventListener('paste', (e) => e.preventDefault());      // Previene pegar
                });
            }
            // Obtener los datos desde Django
            const reporteControlHorario = JSON.parse('{{ reporte_control_horario|safe }}');
            function initializeTempusDominus(row) {
                const inicioId = `#id_inicio_${row}`;
                const finalId = `#id_final_${row}`;
                
                if (document.querySelector(inicioId) && document.querySelector(finalId)) {
                    const inicioPicker = new tempusDominus.TempusDominus(document.querySelector(inicioId), options);
                    const finalPicker = new tempusDominus.TempusDominus(document.querySelector(finalId), options);

                    // Deshabilitar la entrada manual
                    disableManualInput(inicioId);
                    disableManualInput(finalId);

                    $(inicioId + ', ' + finalId).on('change', function() {
                        recalculateSequentialHours();
                    });
                } else {
                    console.error(`No se encontró el elemento para Tempus Dominus con los ids: ${inicioId} o ${finalId}`);
                }
            }

            function recalculateSequentialHours() {
                let previousFinal = null;
                let totalMinutes = 0;

                $('#datatable-controlhorario tbody tr').each(function(index) {
                    const row = index + 1;
                    const $inicio = $(`#id_inicio_${row}`);
                    const $final = $(`#id_final_${row}`);
                    const $total = $(`#id_total_${row}`);

                    // Hacer que el inicio sea readonly desde la segunda fila en adelante
                    if (index > 0) {
                        $inicio.prop('readonly', true);
                    }

                    if ($inicio.length && $final.length && $total.length) {
                        let inicioVal = $inicio.val();
                        let finalVal = $final.val();

                        // Si hay una fila anterior, usar el final de la fila anterior como el inicio de la actual
                        if (previousFinal) {
                            inicioVal = previousFinal;
                            $inicio.val(inicioVal); // Actualiza el valor del inicio
                        }

                        if (inicioVal && finalVal) {
                            const format = 'HH:mm';
                            const inicioDate = moment(inicioVal, format);
                            let finalDate = moment(finalVal, format);

                            // Si la hora final es anterior a la hora de inicio, sumar un día
                            if (finalDate.isBefore(inicioDate)) {
                                finalDate.add(1, 'day');
                            }

                            const duration = moment.duration(finalDate.diff(inicioDate));
                            const hours = Math.floor(duration.asHours());
                            const minutes = duration.minutes();
                            const totalTime = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                            $total.val(totalTime);

                            // Acumular minutos
                            totalMinutes += (hours * 60 + minutes);

                            // Guardar el valor final para la siguiente fila
                            previousFinal = finalVal;
                        }
                    }
                });

                const sumaHoras = moment.utc(totalMinutes * 60 * 1000).format('HH:mm');

                // Si quieres mostrarlo en algún lado del HTML:
                $('#total-horas-acumuladas').text(sumaHoras);
            }

            function createRow(data = {}) {
                rowCount++;

                const newRowHtml = `
                    <tr>
                        <td><input type="text" id="id_inicio_${rowCount}" name="inicio_${rowCount}" class="form-control tempus-dominus" autocomplete="off" value="${data.inicio || ''}" ${rowCount > 1 ? 'readonly' : ''} required ${disabledAttr}></td>
                        <td><input type="text" id="id_final_${rowCount}" name="final_${rowCount}" class="form-control tempus-dominus" autocomplete="off" value="${data.final || ''}" required ${disabledAttr}></td>
                        <td><input type="text" id="id_total_${rowCount}" name="total_${rowCount}" class="form-control" autocomplete="off" value="${data.total || ''}" readonly></td>
                        <td>
                            <select id="id_detalleControlHorario_${rowCount}" name="detalleControlHorario_${rowCount}" class="form-control" required ${disabledAttr}>
                                <option value="" selected>Seleccione una opción</option>
                                {% for detalle in detalles_control_horario %}
                                    <option value="{{ detalle.id }}" ${data.detalleControlHorario === {{ detalle.id }} ? 'selected' : ''}>{{ detalle.detalle }}</option>
                                {% endfor %}
                            </select>
                        </td>
                    </tr>`;
                
                $('#datatable-controlhorario tbody').append(newRowHtml);
                $('#id_detalleControlHorario_' + rowCount).select2({
                    placeholder: "Seleccione una opción",
                    allowClear: true
                });
                initializeTempusDominus(rowCount);
            }

            // Crear filas iniciales desde los datos de la vista
            $('#datatable-controlhorario tbody').empty();
            reporteControlHorario.forEach(data => {
                createRow(data);
            });

            $('#agregarHorario').on('click', function() {
                const lastRow = $('#datatable-controlhorario tbody tr:last');
                const isCompleteHorario = lastRow.find('input').toArray().every(input => input.value.trim() !== '');

                if (isCompleteHorario) {
                    rowCount++;

                    const lastFinalValue = lastRow.find('input[name^="final"]').val(); 

                    const newRowHtml = `
                        <tr>
                            <td><input type="text" id="id_inicio_${rowCount}" name="inicio_${rowCount}" class="form-control tempus-dominus" autocomplete="off" value="${lastFinalValue}" readonly></td>
                            <td><input type="text" id="id_final_${rowCount}" name="final_${rowCount}" class="form-control tempus-dominus" autocomplete="off" required></td>
                            <td><input type="text" id="id_total_${rowCount}" name="total_${rowCount}" class="form-control" autocomplete="off" readonly></td>
                            <td>
                                <select id="id_detalleControlHorario_${rowCount}" name="detalleControlHorario_${rowCount}" class="form-control" required>
                                    <option value="" selected>Seleccione una opción</option>
                                    {% for detalle in detalles_control_horario %}
                                        <option value="{{ detalle.id }}">{{ detalle.detalle }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>`;

                    $('#datatable-controlhorario tbody').append(newRowHtml);
                    $('#id_detalleControlHorario_' + rowCount).select2({
                        placeholder: "Seleccione una opción",
                        allowClear: true
                    });
                    initializeTempusDominus(rowCount);

                    // Recalcular las horas después de agregar una nueva fila
                    recalculateSequentialHours();
                } else {
                    alert('Completa todos los campos antes de agregar una nueva fila.');
                }
            });

            $('#eliminarHorario').on('click', function() {
                const rowCount = $('#datatable-controlhorario tbody tr').length;
                if (rowCount > 1) {
                    $('#datatable-controlhorario tbody tr:last').remove();

                    // Recalcular las horas después de eliminar una fila
                    recalculateSequentialHours();
                } else {
                    alert('Debe haber al menos una fila en la tabla.');
                }
            });

            // Configurar readonly para todas las filas iniciales y bloquear clic en campos readonly
            recalculateSequentialHours();
        } else {
            const options = {
                display: {
                    viewMode: 'calendar',
                    icons: {
                        type: 'icons',
                        up: 'icon-arrow-up',
                        down: 'icon-arrow-down',
                    },
                    components: {
                        calendar: false,
                        minutes: true,
                        seconds: false,
                    },
                },
                stepping: 15,
                localization: {
                    hourCycle: 'h23',
                    dateFormats: {
                        LT: 'HH:mm',
                    },
                    ordinal: (n) => n,
                    format: 'LT',
                }
            };
    
            let rowCount = 0;
    
            function disableManualInput(selector) {
                document.querySelectorAll(selector).forEach(input => {
                    input.addEventListener('keypress', (e) => e.preventDefault());  // Previene escribir
                    input.addEventListener('keydown', (e) => e.preventDefault());    // Previene usar teclas
                    input.addEventListener('paste', (e) => e.preventDefault());      // Previene pegar
                });
            }
    
            function initializeTempusDominus(row) {
                const inicioId = `#id_inicio_${row}`;
                const finalId = `#id_final_${row}`;
                
                // Verifica si los elementos existen antes de inicializar Tempus Dominus
                if (document.querySelector(inicioId) && document.querySelector(finalId)) {
                    const inicioPicker = new tempusDominus.TempusDominus(document.querySelector(inicioId), options);
                    const finalPicker = new tempusDominus.TempusDominus(document.querySelector(finalId), options);
    
                    // Deshabilitar la entrada manual
                    disableManualInput(inicioId);
                    disableManualInput(finalId);
    
                    // Vincula el cálculo de horas al cambio de valor
                    $(inicioId + ', ' + finalId).on('change', function() {
                        recalculateAllRows();
                    });
                } else {
                    console.error(`No se encontró el elemento para Tempus Dominus con los ids: ${inicioId} o ${finalId}`);
                }
            }
    
            function recalculateAllRows() {
                let previousFinal = null;
                let totalMinutes = 0;
    
                $('#datatable-controlhorario tbody tr').each(function(index) {
                    const row = index + 1;
                    const $inicio = $(`#id_inicio_${row}`);
                    const $final = $(`#id_final_${row}`);
                    const $total = $(`#id_total_${row}`);
    
                    // Hacer que el campo inicio sea readonly desde la segunda fila
                    if (index > 0) {
                        $inicio.prop('readonly', true);
                    }
    
                    // Actualizar el inicio con el valor final de la fila anterior
                    if (previousFinal && $inicio.length) {
                        $inicio.val(previousFinal);
                    }
    
                    if ($inicio.length && $final.length && $total.length) {
                        let inicioVal = $inicio.val();
                        let finalVal = $final.val();
    
                        // Verificar y calcular la duración solo si ambos valores están presentes
                        if (inicioVal && finalVal) {
                            const format = 'HH:mm';
                            const inicioDate = moment(inicioVal, format);
                            let finalDate = moment(finalVal, format);
    
                            // Si la hora final es anterior a la hora de inicio, sumar un día
                            if (finalDate.isBefore(inicioDate)) {
                                finalDate.add(1, 'day');
                            }
    
                            const duration = moment.duration(finalDate.diff(inicioDate));
                            const hours = Math.floor(duration.asHours());
                            const minutes = duration.minutes();
                            const totalTime = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                            $total.val(totalTime);

                            // Acumular minutos
                            totalMinutes += (hours * 60 + minutes);
                            
                            // Guardar el valor final para la siguiente fila
                            previousFinal = finalVal;
                        } else {
                            previousFinal = null; // Resetea si no se completa la hora final
                        }
                    }
                });

                const sumaHoras = moment.utc(totalMinutes * 60 * 1000).format('HH:mm');

                // Si quieres mostrarlo en algún lado del HTML:
                $('#total-horas-acumuladas').text(sumaHoras);
            }
    
            function createInitialRow() {
                rowCount++;
    
                const newRowHtml = `
                    <tr>
                        <td><input type="text" id="id_inicio_${rowCount}" name="inicio_${rowCount}" class="form-control tempus-dominus" autocomplete="off" required></td>
                        <td><input type="text" id="id_final_${rowCount}" name="final_${rowCount}" class="form-control tempus-dominus" autocomplete="off" required></td>
                        <td><input type="text" id="id_total_${rowCount}" name="total_${rowCount}" class="form-control" autocomplete="off" readonly></td>
                        <td>
                            <select id="id_detalleControlHorario_${rowCount}" name="detalleControlHorario_${rowCount}" class="form-control" required>
                                <option value="" selected>Seleccione una opción</option>
                                {% for detalle in detalles_control_horario %}
                                    <option value="{{ detalle.id }}">{{ detalle.detalle }}</option>
                                {% endfor %}
                            </select>
                        </td>
                    </tr>`;
                $('#datatable-controlhorario tbody').append(newRowHtml);
                $('#id_detalleControlHorario_' + rowCount).select2({
                    placeholder: "Seleccione una opción",
                    allowClear: true
                });
    
                initializeTempusDominus(rowCount);
            }
            $('#datatable-controlhorario tbody').empty();
            createInitialRow();
    
            $('#agregarHorario').on('click', function() {
                const lastRow = $('#datatable-controlhorario tbody tr:last');
                const isCompleteHorario = lastRow.find('input').toArray().every(input => input.value.trim() !== '');
    
                if (isCompleteHorario) {
                    rowCount++;
    
                    const lastFinalValue = lastRow.find('input[name^="final"]').val(); 
    
                    const newRowHtml = `
                        <tr>
                            <td><input type="text" id="id_inicio_${rowCount}" name="inicio_${rowCount}" class="form-control tempus-dominus" autocomplete="off" value="${lastFinalValue}" readonly></td>
                            <td><input type="text" id="id_final_${rowCount}" name="final_${rowCount}" class="form-control tempus-dominus" autocomplete="off" required></td>
                            <td><input type="text" id="id_total_${rowCount}" name="total_${rowCount}" class="form-control" autocomplete="off" readonly></td>
                            <td>
                                <select id="id_detalleControlHorario_${rowCount}" name="detalleControlHorario_${rowCount}" class="form-control" required>
                                    <option value="" selected>Seleccione una opción</option>
                                    {% for detalle in detalles_control_horario %}
                                        <option value="{{ detalle.id }}">{{ detalle.detalle }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>`;
    
                    // Agregar la nueva fila al cuerpo de la tabla
                    $('#datatable-controlhorario tbody').append(newRowHtml);
                    $('#id_detalleControlHorario_' + rowCount).select2({
                        placeholder: "Seleccione una opción",
                        allowClear: true,
                        width: '100% !important',
                        containerCssClass: "mi-clase-contenedor", 
    
                    });
    
                    // Inicializar tempus-dominus en la nueva fila
                    initializeTempusDominus(rowCount);
    
                    // Recalcular todas las filas
                    recalculateAllRows();
                } else {
                    alert('Completa todos los campos antes de agregar una nueva fila.');
                }
            });
    
            // Función para eliminar la última fila
            $('#eliminarHorario').on('click', function() {
                const rowCount = $('#datatable-controlhorario tbody tr').length;
                if (rowCount > 1) {
                    $('#datatable-controlhorario tbody tr:last').remove();
    
                    // Recalcular todas las filas después de eliminar una fila
                    recalculateAllRows();
                } else {
                    alert('Debe haber al menos una fila en la tabla.');
                }
            });
    
            // Recalcular todas las filas al cargar la página
            recalculateAllRows();
            
        }
    });

</script>
<script>//DESABILITAR CAMPOS
    $(document).ready(function() {
        // DESABILITAR CAMPOS (reporte digital) 
        var campos = ['#id_sondajeCodigo', '#id_sondajeEstado', '#id_sonda', '#id_turno'];
        campos.forEach(function(selector) {
            var $field = $(selector);
            if ($field.attr('readonly')) {
                $field.on('mousedown', function(e) {
                    e.preventDefault(); // evita que se abra el desplegable
                });
            }
        });
    });
</script>
<script>//OBTENER ESTADO SONDA
    $(document).ready(function() {
        function obtenerEstadoSonda() {
            const sonda = $('#id_sonda').val();
            if (sonda) {
                $.LoadingOverlay("show");
                $.ajax({
                    url: "{% url 'obtener_estado_sonda' %}",
                    method: 'GET',
                    data: {
                        'sonda': sonda,
                    },
                    dataType: 'json',
                    success: function(response) {
                        $.LoadingOverlay("hide");
                    },
                    error: function(xhr, status, error) {
                        $.LoadingOverlay("hide");
                        $('.changed').removeClass('changed');
                        Swal.fire({
                            icon: 'error',
                            titleText: 'Reportes Pendientes!',
                            text: 'Reviselos o contacte a su supervisor',
                            confirmButtonColor: '#ff00d9',
                        }).then(() => {
                            window.location.href = '{% url 'manage_mis_reportes_digitales' %}';
                        });
                    }
                });
            } else {
                //alert("Debe ingresar tanto el código como la serie del sondaje.");
            }
        }
        //$('#id_sonda').on('change', obtenerEstadoSonda);
    });
</script>
<script>//DESABILITAR CAMPOS
    $(document).ready(function() {
        // Selecciona el campo que quieres deshabilitar
        var selectField = $('#id_sondajeCodigo');

        // Si está deshabilitado, evitamos que se abra el desplegable
        if (selectField.attr('readonly')) {
            selectField.on('mousedown', function(e) {
                e.preventDefault(); // Evitar el despliegue de opciones
            });
        }
    });
</script>
<script>
    document.addEventListener('keydown', function (e) {
        if (e.target.classList && e.target.classList.contains('solo-enteros')) {
            if (e.key === '.' || e.key === ',') {
                e.preventDefault();
        }
    }
});
document.addEventListener('input', function (e) {
        if (e.target.classList && e.target.classList.contains('solo-enteros')) {
            e.target.value = e.target.value.replace(/[.,]/g, '');
    }
});
</script>
<script> // no dejar abrir ni cambiar el select 
$(function () {
    const camposSalida = [
        '#id_turno_salida',
        '#id_sonda_salida',
        '#id_sondaje_salida',
        '#id_serie_salida',
        '#id_estado_salida',
    ];
    camposSalida.forEach(function (campo) {
        const $field = $(campo);
        if ($field.attr('readonly')) {
            $field.on('mousedown keydown', function (e) {
                e.preventDefault(); 
            });
        }
    });
});
</script>

{% endblock javascript %}

{% block messages %}
{% endblock messages%}