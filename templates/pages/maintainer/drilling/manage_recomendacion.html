{% extends 'main/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Administrar Recomendaciones{% endblock %}

{% block css %}
    <link href="{% static 'css/jquery.dataTables.min.css' %}" rel="stylesheet" />
    <link href="{% static 'css/responsive.dataTables.min.css' %}" rel="stylesheet" />

    <style>
        /* API Houdini para animar colores de degradado */
        @property --c1 { syntax: '<color>'; inherits: false; initial-value: #95a5a6; }
        @property --c2 { syntax: '<color>'; inherits: false; initial-value: #7f8c8d; }
        @property --pos-x { syntax: '<percentage>'; inherits: false; initial-value: 50%; }

        /* Estilo base del botón/selector */
       .estado-selector {
            /* Aumentamos el padding derecho a 35px para que el texto no tape la flecha */
            padding: 6px 35px 6px 15px;
            border-radius: 4px;
            color: white; 
            font-weight: 600;
            border: none;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none; 
            text-align: center;
            width: 140px; /* Aumentado ligeramente para acomodar la flecha */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);

            /* Capa 1: Flecha SVG Blanca */
            /* Capa 2: Tu degradado animado */
            background-image: 
                url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e"),
                linear-gradient(to right, var(--c1), var(--c2), var(--c1));
            
            /* Tamaño: Flecha (20px), Degradado (200%) */
            background-size: 20px 20px, 200% 100%;
            
            /* Posición: Flecha pegada a la derecha, Degradado sigue la variable --pos-x */
            background-position: calc(100% - 8px) center, var(--pos-x) center;
            
            background-repeat: no-repeat;
            
            /* Transiciones suaves */
            transition: --c1 0.6s ease, --c2 0.6s ease, box-shadow 0.3s;
        }

        /* Opciones del desplegable (Fondo blanco, texto oscuro) */
        .estado-selector option {
            color: #333333;
            background-color: #ffffff;
            font-weight: normal;
        }

        /* Clases de utilidad para el color del texto */
        .texto-claro { color: #ffffff !important; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }

        /* Animación de brillo (shine) */
        @keyframes shine {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); transform: scale(1); }
            50% { box-shadow: 0 0 20px 10px rgba(255, 255, 255, 0); transform: scale(1.05); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); transform: scale(1); }
        }
        
        .shine-active { 
            animation: shine 0.5s ease-out; 
        }
    </style>
{% endblock css %}

{% block content %}

<div class="app-content main-content mt-0">
    <div class="side-app"> <!-- CONTAINER -->
        <div class="main-container container-fluid"> <!-- PAGE-HEADER -->
            <div class="page-header">
                <div>
                    <h1 class="page-title">Administrar Recomendaciones</h1>
                </div>
                <div class="ms-auto pageheader-btn">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="javascript:void(0);">Mantenedor Sistema</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Administrar Recomendaciones</li>
                    </ol>
                </div>
            </div> <!-- PAGE-HEADER END --> <!-- row -->  
            <a class="btn btn-primary btn-size-new" href="{% url 'new_recomendacion' %}">Nueva Recomendación</a>  
            <h5 class="mb-5"></h5>
            <div class="row row-sm"> 
                <table id="datatable-allusers" class="display nowrap" style="width:100%">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Recomendación</th>
                            <th>Pozo</th>
                            <th>Sonda</th>
                            <th>Fecha Inicio</th>
                            <th>Estado</th>
                            <th>Largo Programado</th>
                            <th>Largo Real</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for documento in documentos %}                            
                            <tr>
                                <td class="dtr-control"></td>
                                <td>{{ documento.recomendacion }}</td>
                                <td>{{ documento.pozo }}</td>
                                <td>{{ documento.sonda }}</td>
                                <td>{{ documento.fecha_inicio|date:"d-m-Y" }}</td>
                                
                                <td data-search="{{ documento.get_estado_display }}">
                                    <select class="estado-selector i" 
                                            data-id="{{ documento.id }}" 
                                            data-estado-inicial="{{ documento.estado|default:'default' }}"
                                            onchange="cambiarEstadoRecomendacion(this)"
                                            onmousemove="moverDegrade(event, this)"
                                            onmouseleave="resetDegrade(this)">
                                        
                                        <option value="1" {% if documento.estado == '1' %}selected{% endif %}>Abortado</option>
                                        
                                        <option value="2" {% if documento.estado == '2' %}selected{% endif %}>En Avance</option>
                                        <option value="3" {% if documento.estado == '3' %}selected{% endif %}>En Espera</option>
                                        <option value="4" {% if documento.estado == '4' %}selected{% endif %}>Finalizado</option>
                                    
                                    </select>
                                                                                
                                </td>
                                <td>{% if documento.largo_programado is None %}Sin asignar{% else %}{{ documento.largo_programado }}{% endif %}</td>
                                <td>{{ documento.largo_real }}</td>
                                <td class="form-inline-btn">
                                    <form action="{% url 'edit_recomendacion' %}" method="POST" >
                                        {% csrf_token %}
                                        <input type="hidden" name="id" value="{{ documento.id }}">
                                        <button type="submit" class="btn btn-info btn-size-edit">Editar</button> 
                                    </form> 
                                </td>                                 
                            </tr>                          
                        {% endfor %}
                    </tbody>                    
                </table>
            </div>            
        </div>
        <h5 class="mb-5"></h5> 
        <div class="main-container container-fluid"> 
            <a class="btn btn-secondary" href="{% url 'dashboardSondaje' %}">Regresar</a> 
        </div>
    </div>
</div>

{% endblock content %}

{% block javascript %}
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

<script type="text/javascript">
    // ==========================================
    // 1. LÓGICA DE COLORES Y ESTADOS
    // ==========================================
    const COLORES = {
        '1': { c1: '#e74c3c', c2: '#c0392b', texto: 'claro' }, // Abortado
        '2': { c1: '#3498db', c2: '#2980b9', texto: 'claro' }, // Avance
        '3': { c1: '#f1c40f', c2: '#f39c12', texto: 'oscuro' }, // Espera
        '4': { c1: '#2ecc71', c2: '#27ae60', texto: 'claro' }, // Finalizado
        'default': { c1: '#95a5a6', c2: '#7f8c8d', texto: 'claro' }
    };

    function aplicarColores(selector, valor) {
        const config = COLORES[valor] || COLORES['default'];
        selector.style.setProperty('--c1', config.c1);
        selector.style.setProperty('--c2', config.c2);
        
        if (config.texto === 'oscuro') {
            selector.classList.add('texto-oscuro');
            selector.classList.remove('texto-claro');
        } else {
            selector.classList.add('texto-claro');
            selector.classList.remove('texto-oscuro');
        }
    }

    function pintarSelectores() {
        $('.estado-selector').each(function() {
            let sel = $(this);
            let estadoActual = sel.val() || sel.attr('data-estado-inicial');
            aplicarColores(this, estadoActual);
        });
    }

    // --- Efectos Visuales ---
    function moverDegrade(e, selector) {
        const rect = selector.getBoundingClientRect();
        const x = e.clientX - rect.left; 
        const porcentaje = (x / rect.width) * 100;
        selector.style.setProperty('--pos-x', `${porcentaje}%`);
    }

    function resetDegrade(selector) {
        selector.style.setProperty('--pos-x', '50%');
    }

    // --- Cambio de Estado (AJAX) ---
    function cambiarEstadoRecomendacion(selector) {
        let id = selector.getAttribute('data-id');
        let nuevoEstado = selector.value;
        let csrfToken = '{{ csrf_token }}';
        let textoVisible = selector.options[selector.selectedIndex].text;

        $.ajax({
            url: "{% url 'update_estado_recomendacion' %}",
            type: "POST",
            data: { 'id': id, 'estado': nuevoEstado, 'csrfmiddlewaretoken': csrfToken },
            success: function(response) {
                if (response.success) {
                    // 1. Feedback visual
                    aplicarColores(selector, nuevoEstado);
                    selector.classList.add('shine-active');
                    setTimeout(() => { selector.classList.remove('shine-active'); }, 500);

                    // 2. Actualizar DataTable sin reiniciar (draw(false) mantiene la paginación)
                    let tdPadre = selector.closest('td');
                    tdPadre.setAttribute('data-search', textoVisible);
                    
                    // Verificamos que la tabla exista antes de llamar a la API
                    if ($.fn.DataTable.isDataTable('#datatable-allusers')) {
                        $('#datatable-allusers').DataTable().cell(tdPadre).invalidate().draw(false);
                    }
                } else {
                    Swal.fire('Error', response.message, 'error');
                }
            },
            error: function() {
                Swal.fire('Error', 'Error de servidor', 'error');
            }
        });
    }

    // ==========================================
    // 2. INICIALIZACIÓN ÚNICA
    // ==========================================
    $(document).ready(function() {
        // SEGURIDAD: Solo inicializamos si NO existe ya una instancia de DataTable en este ID
        if ( ! $.fn.DataTable.isDataTable( '#datatable-allusers' ) ) {
            
            new DataTable('#datatable-allusers', {
                columnDefs: [
                    { className: 'dtr-control', orderable: false },
                    { searchable: false, targets: [0, 8]},
                    { orderable: false, targets: [0, 8, 5]}
                ],
                language: {
                    url: '{% static 'json/es-CL.json' %}',        
                },
                responsive: {
                    details: { type: 'column' }
                },
                // Esto asegura que los colores se apliquen al filtrar/paginar
                drawCallback: function(settings) {
                    pintarSelectores();
                }
            });

        } else {
            // Si la tabla ya existía (por alguna razón del sistema), 
            // solo nos aseguramos de pintar los colores actuales
            pintarSelectores();
        }
    });
</script>
{% endblock javascript %}